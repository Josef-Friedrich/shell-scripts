#!/bin/sh

. ../helper.lib

P=../../

test_parameters() {
	assert_fail "${P}imagemagick-imslp.sh" > /dev/null 2>&1
}

test_help() {
	assert "${P}imagemagick-imslp.sh -h"  > /dev/null 2>&1
}

test_source() {
	. ${P}imagemagick-imslp.sh.00
	assert_equals "$(_usage | head -n 1)" "Usage: bash_unit [-bcfhrt] <filename-or-glob-pattern>"
}

test_remove_extension() {
	. ${P}imagemagick-imslp.sh.00
	assert_equals "$(_remove_extension filename.png)" "filename"
	assert_equals "$(_remove_extension filename.png.png)" "filename.png"
}

test_get_channels_input() {
	. ${P}imagemagick-imslp.sh.00
	local TMP=$(mktemp)
  fake identify 'echo $FAKE_PARAMS > $TMP'
  _get_channels filename.png
  assert_equals filename.png "$(head -n1 $TMP)"
	rm -f "$TMP"
}

test_get_channels_output() {
	. ${P}imagemagick-imslp.sh.00

	fake identify << EOF
TFKBexample-2.png PNG 4868x2623 4868x2623+0+0 8-bit sRGB 2c 104KB 0.000u 0:00.000
EOF

  assert_equals "$(_get_channels filename.png)" 2c
}

test_defaults() {
	. ${P}imagemagick-imslp.sh.00
  assert_equals "$OUT_EXT" png
	assert_equals "$THRESHOLD" 50%
	assert_equals "$COMPRESSION" ''
	assert_equals "$OPT_RESIZE" ''
}

test_unit_options() {
	. ${P}imagemagick-imslp.sh.00
  assert_equals "$(_options)" '-deskew 40% -threshold 50% -trim +repage'
}

test_unit_options_c_ccitt() {
	. ${P}imagemagick-imslp.sh.00
	OPT_CCITT=1
  assert_equals "$(_options)" '-deskew 40% -threshold 50% -trim +repage -compress Group4 -monochrome'
}

test_unit_options_r_resize() {
	. ${P}imagemagick-imslp.sh.00
	OPT_RESIZE='-resize 200% '
  assert_equals "$(_options)" '-resize 200% -deskew 40% -threshold 50% -trim +repage'
}

test_without_options() {
	_set_mocking_path imagemagick-imslp
	assert_equals "$(${P}imagemagick-imslp.sh pic.jpg | sed -n 1p)" 'Convert pic.jpg to pic.png'
	assert_equals "$(${P}imagemagick-imslp.sh pic.jpg | sed -n 2p)" 'pic.jpg -deskew 40% -threshold 50% -trim +repage pic.png'
}

test_option_c_ccitt() {
	_set_mocking_path imagemagick-imslp
	assert_equals "$(${P}imagemagick-imslp.sh -c pic.jpg | sed -n 2p)" 'pic.jpg -deskew 40% -threshold 50% -trim +repage -compress Group4 -monochrome pic.pdf'
}


test_option_r_resize() {
	_set_mocking_path imagemagick-imslp
	assert_equals "$(${P}imagemagick-imslp.sh -r pic.jpg | sed -n 2p)" 'pic.jpg -resize 200% -deskew 40% -threshold 50% -trim +repage pic.png'
}
